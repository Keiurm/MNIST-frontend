<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>MNIST FRONTEND</title>
<!-- jQuery とBootstrapをCDNから読み込み -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<style>
#canvas{
    display:block;
    margin:auto;
}
.canvas-container{
     margin-right:auto;
     margin-left:auto;
     width:600px;
     padding-top:30px;
     padding-bottom:30px;
}
</style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <a href="#" class="navbar-brand">MNIST-frontend</a>
    </nav>
    <div class="container" style="max-width:600px">
        <div class="canvas-container">
                <canvas id="canvas" class="border border-info" width="200" height="200"></canvas>
        </div>
        <div class=".text-center">
        <input type="button" id="send" value="判定" class="btn btn-outline-primary w-100"><br>
        <input type="button" value="clear" id="clear" class="btn btn-outline-secondary w-100">
        <table id="result" class="table"></table>
        </div>
    </div>

    <script>
    // <canvas>をcnvsで参照して操作する
    var cnvs = document.getElementById('canvas');
    // 平面でcanvasに描画する場合は 2Dのコンテキストを取得
    //  (コンテキストは描画等を行うオブジェクトのようなもの)
    var ctx = cnvs.getContext('2d');
 
    // Canvasのサイズ
    const cnvWidth = 200;
    const cnvHeight = 200;

    var cnvColor = "0, 0, 0";  // 線の色
    var cnvBold = 20;  // 線の太さ
    var clickFlg = 0;  // クリック中の判定 1:クリック開始 2:クリック中
    var bgColor = "rgb(255,255,255)";
    ctx.fillStyle = bgColor;
    ctx.fillRect(0,0,cnvWidth,cnvHeight); 
 
    // canvas上でのイベント
    $("#canvas").mousedown(function(){
      clickFlg = 1; // マウス押下開始
    }).mouseup(function(){
      clickFlg = 0; // マウス押下終了
    }).mousemove(function(e){
      // マウス移動処理
      if(!clickFlg) return false;
      draw(e.offsetX, e.offsetY);
    });
 
    // 描画処理
    function draw(x, y) {
      ctx.lineWidth = cnvBold;
      ctx.strokeStyle = 'rgb('+cnvColor+')';
      // 初回処理の判定
      if (clickFlg == "1") {
        clickFlg = "2";
        ctx.beginPath();
        ctx.lineCap = "round";  //　線を角丸にする
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
      ctx.stroke();
    };
 
  
    // 描画クリア
    $("#clear").click(function(){
      ctx.clearRect(0,0,cnvWidth,cnvHeight);
    });
    // 下記を参考のこと
    //https://qiita.com/0829/items/a8c98c8f53b2e821ac94
    //https://qiita.com/conta_/items/047c2ad89f43ade5dab3
    // http://motojapan.hateblo.jp/entry/2017/12/19/112544
    // canvasを画像で保存
    $("#send").click(function(){
      canvas = document.getElementById('canvas');
      var base64 = canvas.toDataURL("image/png");
      var fData = new FormData();
      fData.append('img', base64);

      //#ajax送信
      $.ajax({
          //画像処理サーバーに返す場合
          url: 'http://127.0.0.1:10000/estimate',   
          type: 'POST',
          data: fData ,
          contentType: false,
          processData: false,
          success: function(data, dataType) {
              //非同期で通信成功時に読み出される [200 OK 時]
              console.log('Success', data);
              $("#result").empty();
              $("#result").append("<tbody>")
              jQuery.each(data, function(k, v) {
                  $('#result').append("<tr><td>"+k+"</td><td>" + v.toString()+"</td></tr>");
              });
              $("#result").append("</tbody>")
              $("#result").addClass("table-striped");
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
              //非同期で通信失敗時に読み出される
               console.log('Error : ' + errorThrown);
          }
        });
    });

  </script>
</body>
</html>
